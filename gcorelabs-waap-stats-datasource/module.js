/* [create-plugin] version: 6.1.4 */
/* [create-plugin] plugin: gcore-waap-datasource@1.0.0 */
define(["@grafana/ui","@grafana/runtime","@grafana/data","react"],(e,t,r,a)=>(()=>{"use strict";var n={7:t=>{t.exports=e},531:e=>{e.exports=t},781:e=>{e.exports=r},959:e=>{e.exports=a}},o={};function s(e){var t=o[e];if(void 0!==t)return t.exports;var r=o[e]={exports:{}};return n[e](r,r.exports,s),r.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};s.r(i),s.d(i,{plugin:()=>N});var l=s(781),c=s(531),u=function(e){return e.Bytes="Bytes",e.KBytes="KBytes",e.MBytes="MBytes",e.GBytes="GBytes",e}({});const d=(e,t,r=2)=>{switch(t){case"Bytes":return Number(e.toFixed(r));case"KBytes":return Number((e/1024).toFixed(r));case"MBytes":return Number((e/1048576).toFixed(r));case"GBytes":return Number((e/1073741824).toFixed(r))}};function p(e,t,r,a,n,o,s){try{var i=e[o](s),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(a,n)}function y(e){return function(){var t=this,r=arguments;return new Promise(function(a,n){var o=e.apply(t,r);function s(e){p(o,a,n,s,i,"next",e)}function i(e){p(o,a,n,s,i,"throw",e)}s(void 0)})}}function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class f extends l.DataSourceApi{query(e){return y(function*(){var t,r,a;const n=e.range.from.toISOString(),o=e.range.to.toISOString(),s=(null===(t=e.targets[0])||void 0===t?void 0:t.granularity)||"1h",i=e.targets;var l;const c=[null!==(l=null===(r=i[0])||void 0===r?void 0:r.metric)&&void 0!==l?l:Array.isArray(null===(a=i[0])||void 0===a?void 0:a.metrics)?i[0].metrics[0]:"total_requests"];return{data:yield this.seriesCall({from:n,to:o,granularity:s,metrics:c})}}).call(this)}testDatasource(){return y(function*(){const e=e=>y(function*(){return(0,c.getBackendSrv)().datasourceRequest({method:"GET",url:`/api/datasources/proxy/uid/${this.instanceSettings.uid}/${e}`,responseType:"json",showErrorAlert:!0})}).call(this);try{var t;var r;return{status:"success",message:`Auth OK (IAM): ${null!==(r=null===(t=(yield e("iam/users/me")).data)||void 0===t?void 0:t.name)&&void 0!==r?r:"OK"}`}}catch(t){var a;var n;return{status:"success",message:`Auth OK: ${null!==(n=null===(a=(yield e("users/me")).data)||void 0===a?void 0:a.name)&&void 0!==n?n:"OK"}`}}}).call(this)}seriesCall(e){return y(function*(){const t=new URLSearchParams;t.append("from",e.from),t.append("to",e.to),t.append("granularity",e.granularity);for(const r of e.metrics)t.append("metrics",r);const r=`/api/datasources/proxy/uid/${this.instanceSettings.uid}/waap/v1/statistics/series?${t.toString()}`,a=yield(0,c.getBackendSrv)().datasourceRequest({url:r,method:"GET"}),n=(null==a?void 0:a.data)||{},o=[];for(const[e,t]of Object.entries(n)){if(!Array.isArray(t))continue;const r="total_bytes"===e,a=new l.MutableDataFrame({name:e,fields:[{name:"time",type:l.FieldType.time,values:[]},{name:e,type:l.FieldType.number,config:{unit:r?"kbytes":"short",decimals:2,displayName:r?"Total Bytes (KB)":"Total Requests"},values:[]}]});for(const n of t){const t=Number(n.value);a.add({time:Date.parse(n.date_time),[e]:r?d(t,u.KBytes):t})}o.push(a)}return o}).call(this)}constructor(e){var t,r;super(e),m(this,"instanceSettings",void 0),m(this,"apiBase",void 0),m(this,"authHeader",void 0),this.instanceSettings=e,this.apiBase=((null===(t=e.jsonData)||void 0===t?void 0:t.apiUrl)||"").replace(/\/+$/,""),this.authHeader=null==e||null===(r=e.decryptedSecureJsonData)||void 0===r?void 0:r.apiKey}}var v=s(959),b=s.n(v),g=s(7);function O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},a=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),a.forEach(function(t){O(e,t,r[t])})}return e}function j(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,a)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function P(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},a=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),a.forEach(function(t){w(e,t,r[t])})}return e}function S(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,a)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const E=[{label:"total_requests",value:"total_requests"},{label:"total_bytes",value:"total_bytes"}],D=[{label:"1h",value:"1h"},{label:"1d",value:"1d"}],N=new l.DataSourcePlugin(f).setConfigEditor(({options:e,onOptionsChange:t})=>{var r,a;const n=null!==(a=e.jsonData)&&void 0!==a?a:{};var o;const s=null!==(o=e.secureJsonData)&&void 0!==o?o:{};return b().createElement(b().Fragment,null,b().createElement("h3",{className:"page-heading"},"WAAP API"),b().createElement("div",{className:"gf-form-group"},b().createElement("div",{className:"gf-form"},b().createElement("span",{className:"gf-form-label width-12"},"API URL (host only)"),b().createElement(g.Input,{className:"width-30",value:n.apiUrl||"",placeholder:"api.gcore.com",onChange:r=>t(j(h({},e),{jsonData:j(h({},n),{apiUrl:r.currentTarget.value})}))})),b().createElement("div",{className:"gf-form"},b().createElement("span",{className:"gf-form-label width-12"},"Authorization header value"),b().createElement(g.SecretInput,{className:"width-30",isConfigured:Boolean(null===(r=e.secureJsonFields)||void 0===r?void 0:r.apiKey),value:s.apiKey||"",placeholder:"apikey <YOUR_TOKEN>",onReset:()=>t(j(h({},e),{secureJsonFields:j(h({},e.secureJsonFields),{apiKey:!1}),secureJsonData:j(h({},s),{apiKey:""})})),onChange:r=>t(j(h({},e),{secureJsonData:j(h({},s),{apiKey:r.currentTarget.value})}))}))))}).setQueryEditor(({query:e,onChange:t,onRunQuery:r})=>{var a;const n=null!==(a=e.metric)&&void 0!==a?a:Array.isArray(e.metrics)?e.metrics[0]:"total_requests",o=e.granularity||"1h";return b().createElement("div",{className:"gf-form-group"},b().createElement("div",{className:"gf-form"},b().createElement("span",{className:"gf-form-label width-9"},"Metric"),b().createElement(g.Select,{className:"width-20",options:E,value:E.find(e=>e.value===n),onChange:a=>{t(S(P({},e),{metric:a.value})),r()}})),b().createElement("div",{className:"gf-form"},b().createElement("span",{className:"gf-form-label width-9"},"Granularity"),b().createElement(g.Select,{className:"width-10",value:{label:o,value:o},options:D,onChange:a=>{t(S(P({},e),{granularity:null==a?void 0:a.value})),r()}})))});return i})());
//# sourceMappingURL=module.js.map